# Google Apps Script 설정 가이드

이 가이드는 예산 관리 시스템과 Google Apps Script를 연동하는 방법을 설명합니다.

## 1. Google Apps Script 프로젝트 생성

1. [Google Apps Script](https://script.google.com)에 접속
2. "새 프로젝트" 클릭
3. 프로젝트 이름 설정 (예: "예산관리시스템 연동")

## 2. 스크립트 코드 작성

**⚠️ 중요**: 전체 기능(숫자 형식, 산식 검증, 조건부 서식 등)을 사용하려면 **`GOOGLE_APPS_SCRIPT_FULL_CODE.js`** 파일의 전체 코드를 복사해야 합니다.

### 전체 코드 사용 (권장)

1. `GOOGLE_APPS_SCRIPT_FULL_CODE.js` 파일 열기
2. **전체 내용을 복사** (Ctrl+A, Ctrl+C)
3. Google Apps Script 편집기에 **모든 기존 코드를 삭제하고 붙여넣기**
4. **저장** (Ctrl+S)

### 주요 기능

전체 코드에는 다음 기능이 포함되어 있습니다:

- ✅ 숫자 천 단위 구분 쉼표 형식 (`#,##0`)
- ✅ 산식 검증 컬럼 (자동 계산)
- ✅ 산식 오류 컬럼 ("정상" 또는 "오류" 표시)
- ✅ 조건부 서식 (오류 행 빨간색 표시)
- ✅ 스프레드시트 제목 자동 설정 (`연도_회차_날짜` 형식)
- ✅ 0인 열 자동 숨기기
- ✅ 시군비 상세 탭 자동 생성
- ✅ 합계 행 자동 추가

### 코드 업데이트 후 필수 작업

코드를 수정한 후에는 **반드시 "새 버전으로 배포"**해야 합니다:

1. "배포" > "배포 관리" 클릭
2. 기존 배포 옆의 **연필 아이콘(편집)** 클릭
3. "버전" 드롭다운에서 **"새 버전"** 선택
4. **"배포"** 클릭
5. 새 Web App URL을 설정 페이지에 입력

자세한 내용은 `GOOGLE_APPS_SCRIPT_UPDATE_INSTRUCTIONS.md` 파일을 참조하세요.

## 3. Web App 배포

1. Apps Script 편집기에서 "배포" > "새 배포" 클릭
2. 유형 선택: "웹 앱"
3. 설정:
   - 설명: "예산 관리 시스템 연동"
   - 다음 사용자로 실행: "나"
   - 액세스 권한: "모든 사용자"
4. "배포" 클릭
5. **Web App URL 복사** (이 URL을 설정 페이지에 입력)

## 4. 권한 승인

1. 처음 실행 시 권한 승인 요청이 나타남
2. "권한 검토" 클릭
3. Google 계정 선택
4. "고급" > "안전하지 않은 페이지로 이동" (필요시)
5. "허용" 클릭

## 5. 설정 페이지에서 URL 입력

1. 예산 관리 시스템의 설정 페이지로 이동
2. "Google Apps Script 연동" 섹션에서 Web App URL 입력
3. 저장

## 주의사항

- Web App URL은 배포할 때마다 변경될 수 있습니다 (버전 관리 사용 권장)
- Google Workspace 계정이 필요할 수 있습니다 (일부 기능)
- 일일 실행 시간 제한이 있습니다 (6분)
- 일일 실행 횟수 제한이 있습니다 (충분한 수준)

## 문제 해결

### CORS 오류 해결

**증상**: "Failed to fetch" 또는 CORS 오류 발생

**해결 방법**:

1. **Web App 배포 설정 확인 (가장 중요!)**:
   - Apps Script 편집기에서 "배포" > "배포 관리" 클릭
   - 기존 배포를 수정하거나 새 배포 생성
   - **반드시 확인할 설정**:
     - "다음 사용자로 실행": **"나"** 선택
     - "액세스 권한": **"모든 사용자"** 선택 (이것이 CORS를 자동으로 처리함)
   - **중요**: 배포 후 URL이 `/exec`로 끝나는지 확인 (`/dev`는 개발용)
   - 배포 후 **새 버전으로 배포** 클릭하여 변경사항 반영

2. **URL 형식 확인**:
   - 올바른 형식: `https://script.google.com/macros/s/.../exec`
   - 잘못된 형식: `https://script.google.com/macros/s/.../dev`

3. **코드 확인**:
   - `doOptions()` 함수가 있는지 확인
   - `setHeaders()` 메서드는 사용하지 않음 (지원하지 않음)

4. **권한 재승인**:
   - Apps Script 편집기에서 "실행" > "doPost" 실행하여 권한 재승인
   - 또는 Web App URL을 브라우저에서 직접 열어서 권한 승인

5. **캐시 클리어**:
   - 브라우저 캐시 및 쿠키 삭제
   - 시크릿 모드에서 테스트

**참고**: Google Apps Script Web App은 "액세스 권한: 모든 사용자"로 설정하면 자동으로 CORS를 처리합니다. 별도의 헤더 설정이 필요하지 않습니다.

### 기타 문제

- **권한 오류**: Apps Script에서 권한을 다시 승인
- **실행 시간 초과**: 데이터 양을 줄이거나 배치 처리
- **연결 실패**: 인터넷 연결 및 방화벽 설정 확인

